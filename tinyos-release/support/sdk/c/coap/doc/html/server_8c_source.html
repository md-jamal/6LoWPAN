<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>libcoap: /home/jumbo/jamal/project/CoAP/tinyos-release/support/sdk/c/coap/examples/server.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">libcoap
   &#160;<span id="projectnumber">0.07</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">/home/jumbo/jamal/project/CoAP/tinyos-release/support/sdk/c/coap/examples/server.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* coap -- simple implementation of the Constrained Application Protocol (CoAP)</span>
<a name="l00002"></a>00002 <span class="comment"> *         as defined in draft-ietf-core-coap-01</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 2010 Olaf Bergmann &lt;bergmann@tzi.org&gt;</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00007"></a>00007 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00009"></a>00009 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00012"></a>00012 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00013"></a>00013 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00014"></a>00014 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00018"></a>00018 <span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>
<a name="l00019"></a>00019 <span class="comment"> */</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;sys/select.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#ifdef HAVE_ASSERT_H</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor"># include &lt;assert.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#else</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor"># define assert(x)</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* HAVE_ASSERT_H */</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;subscribe.h&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;coap.h&quot;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#define COAP_RESOURCE_CHECK_TIME 2</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span>
<a name="l00048"></a>00048 <span class="comment">/* where accessible files are stored */</span>
<a name="l00049"></a>00049 <span class="preprocessor">#define FILE_PREFIX &quot;filestorage&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">#define DATASINK_PREFIX &quot;data-sink/&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00052"></a>00052 <span class="preprocessor">#define GENERATE_PDU(var,t,c,i) {       \</span>
<a name="l00053"></a>00053 <span class="preprocessor">    var = coap_new_pdu();           \</span>
<a name="l00054"></a>00054 <span class="preprocessor">    if (var) {                  \</span>
<a name="l00055"></a>00055 <span class="preprocessor">      var-&gt;hdr-&gt;type = (t);         \</span>
<a name="l00056"></a>00056 <span class="preprocessor">      var-&gt;hdr-&gt;code = (c);         \</span>
<a name="l00057"></a>00057 <span class="preprocessor">      var-&gt;hdr-&gt;id = (i);           \</span>
<a name="l00058"></a>00058 <span class="preprocessor">    }                       \</span>
<a name="l00059"></a>00059 <span class="preprocessor">  }</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span>
<a name="l00061"></a>00061 <span class="comment">/* temporary storage for dynamic resource representations */</span>
<a name="l00062"></a>00062 <span class="keyword">static</span> <span class="keywordtype">char</span> resource_buf[20000];
<a name="l00063"></a>00063 <span class="keyword">static</span> <span class="keywordtype">int</span> quit = 0;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="comment">/* SIGINT handler: set quit to 1 for graceful termination */</span>
<a name="l00066"></a>00066 <span class="keywordtype">void</span>
<a name="l00067"></a>00067 handle_sigint(<span class="keywordtype">int</span> signum) {
<a name="l00068"></a>00068   quit = 1;
<a name="l00069"></a>00069 }
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *
<a name="l00072"></a>00072 new_ack( <a class="code" href="structcoap__context__t.html">coap_context_t</a>  *ctx, <a class="code" href="structcoap__listnode.html">coap_queue_t</a> *node ) {
<a name="l00073"></a>00073   <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *pdu;
<a name="l00074"></a>00074   GENERATE_PDU(pdu,COAP_MESSAGE_ACK,0,node-&gt;pdu-&gt;hdr-&gt;id);
<a name="l00075"></a>00075   <span class="keywordflow">return</span> pdu;
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *
<a name="l00079"></a>00079 new_rst( <a class="code" href="structcoap__context__t.html">coap_context_t</a>  *ctx, <a class="code" href="structcoap__listnode.html">coap_queue_t</a> *node, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> code ) {
<a name="l00080"></a>00080   <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *pdu;
<a name="l00081"></a>00081   GENERATE_PDU(pdu,COAP_MESSAGE_RST,code,node-&gt;pdu-&gt;hdr-&gt;id);
<a name="l00082"></a>00082   <span class="keywordflow">return</span> pdu;
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *
<a name="l00086"></a>00086 new_response( <a class="code" href="structcoap__context__t.html">coap_context_t</a>  *ctx, <a class="code" href="structcoap__listnode.html">coap_queue_t</a> *node, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> code ) {
<a name="l00087"></a>00087   <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *pdu;
<a name="l00088"></a>00088   GENERATE_PDU(pdu,COAP_MESSAGE_ACK,code,node-&gt;pdu-&gt;hdr-&gt;id);
<a name="l00089"></a>00089   <span class="keywordflow">return</span> pdu;
<a name="l00090"></a>00090 }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="keywordtype">void</span>
<a name="l00093"></a>00093 add_contents( <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *pdu, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mediatype, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data ) {
<a name="l00094"></a>00094   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ct = COAP_MEDIATYPE_APPLICATION_LINK_FORMAT;
<a name="l00095"></a>00095   <span class="keywordflow">if</span> (!pdu)
<a name="l00096"></a>00096     <span class="keywordflow">return</span>;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098   <span class="comment">/* add content-encoding */</span>
<a name="l00099"></a>00099   coap_add_option(pdu, COAP_OPTION_CONTENT_TYPE, 1, &amp;ct);
<a name="l00100"></a>00100 
<a name="l00101"></a>00101   <span class="comment">/* TODO: handle fragmentation (check result code) */</span>
<a name="l00102"></a>00102   coap_add_data(pdu, len, data);
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="preprocessor">#define INDEX &quot;This is a test server made with libcoap (see http://libcoap.sf.net)\n&quot; \</span>
<a name="l00106"></a>00106 <span class="preprocessor">          &quot;Copyright (C) 2010 Olaf Bergmann &lt;bergmann@tzi.org&gt;\n\n&quot; \</span>
<a name="l00107"></a>00107 <span class="preprocessor">              &quot;Try to get .well-known/core or POST/PUT data if you like.&quot;</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span>
<a name="l00109"></a>00109 <a class="code" href="unioncoap__opt__t.html">coap_opt_t</a> *
<a name="l00110"></a>00110 coap_next_option(<a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *pdu, <a class="code" href="unioncoap__opt__t.html">coap_opt_t</a> *opt) {
<a name="l00111"></a>00111   <a class="code" href="unioncoap__opt__t.html">coap_opt_t</a> *next;
<a name="l00112"></a>00112   <span class="keywordflow">if</span> ( !pdu || !opt )
<a name="l00113"></a>00113     <span class="keywordflow">return</span> NULL;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115   next = (<a class="code" href="unioncoap__opt__t.html">coap_opt_t</a> *)( (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)opt + COAP_OPT_SIZE(*opt) );
<a name="l00116"></a>00116   <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)next &lt; pdu-&gt;data &amp;&amp; COAP_OPT_DELTA(*next) == 0 ? next : NULL;
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="keywordtype">int</span>
<a name="l00120"></a>00120 mediatype_matches(<a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *pdu, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> mediatype) {
<a name="l00121"></a>00121   <a class="code" href="unioncoap__opt__t.html">coap_opt_t</a> *accept;
<a name="l00122"></a>00122   <span class="keywordtype">int</span> t;
<a name="l00123"></a>00123 
<a name="l00124"></a>00124   <span class="keywordflow">if</span> ( mediatype == COAP_MEDIATYPE_ANY ||
<a name="l00125"></a>00125        (accept = coap_check_option(pdu, COAP_OPTION_ACCEPT)) == NULL)
<a name="l00126"></a>00126     <span class="keywordflow">return</span> 1;
<a name="l00127"></a>00127 
<a name="l00128"></a>00128   <span class="comment">/* Check the byte sequence in the option value for any occurence of</span>
<a name="l00129"></a>00129 <span class="comment">   * mediatype. */</span>
<a name="l00130"></a>00130   <span class="keywordflow">for</span> (t = 0; t &lt; COAP_OPT_LENGTH(*accept); ++t) {
<a name="l00131"></a>00131     <span class="keywordflow">if</span> ( COAP_OPT_VALUE(*accept)[t] == mediatype )
<a name="l00132"></a>00132       <span class="keywordflow">return</span> 1;
<a name="l00133"></a>00133   }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135   <span class="keywordflow">return</span> 0;
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="comment">/* Check if provided path name is a valid CoAP URI path. */</span>
<a name="l00139"></a>00139 <span class="keywordtype">int</span>
<a name="l00140"></a>00140 is_valid(<span class="keywordtype">char</span> *prefix, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length) {
<a name="l00141"></a>00141   <span class="keyword">enum</span> { START, PATH, DOT, DOTDOT } state;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143   <span class="keywordflow">if</span> (!path || length &lt; strlen(prefix) ||
<a name="l00144"></a>00144       strncmp((<span class="keywordtype">char</span> *)path, prefix, strlen(prefix)) != 0)
<a name="l00145"></a>00145     <span class="keywordflow">return</span> 0;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147   path += strlen(prefix);
<a name="l00148"></a>00148   length -= strlen(prefix);
<a name="l00149"></a>00149   <span class="keywordflow">if</span> ( length &amp;&amp; *path == <span class="charliteral">&#39;/&#39;</span> ) {
<a name="l00150"></a>00150     state = START;
<a name="l00151"></a>00151     ++path;
<a name="l00152"></a>00152     --length;
<a name="l00153"></a>00153   } <span class="keywordflow">else</span>
<a name="l00154"></a>00154     state = PATH;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156   <span class="keywordflow">while</span> (length) {
<a name="l00157"></a>00157     <span class="keywordflow">switch</span> (state) {
<a name="l00158"></a>00158       <span class="keywordflow">case</span> START:
<a name="l00159"></a>00159     <span class="keywordflow">switch</span> (path[0]) {
<a name="l00160"></a>00160     <span class="keywordflow">case</span> <span class="charliteral">&#39;.&#39;</span>: state = DOT; <span class="keywordflow">break</span>;
<a name="l00161"></a>00161     <span class="keywordflow">case</span> <span class="charliteral">&#39;/&#39;</span>: <span class="keywordflow">return</span> 0;
<a name="l00162"></a>00162     <span class="keywordflow">default</span>: state = PATH;
<a name="l00163"></a>00163     }
<a name="l00164"></a>00164     <span class="keywordflow">break</span>;
<a name="l00165"></a>00165       <span class="keywordflow">case</span> PATH:
<a name="l00166"></a>00166     <span class="keywordflow">if</span> (path[0] == <span class="charliteral">&#39;/&#39;</span>)
<a name="l00167"></a>00167       state = START;
<a name="l00168"></a>00168     <span class="keywordflow">break</span>;
<a name="l00169"></a>00169       <span class="keywordflow">case</span> DOT:
<a name="l00170"></a>00170     <span class="keywordflow">switch</span> (path[0]) {
<a name="l00171"></a>00171     <span class="keywordflow">case</span> <span class="charliteral">&#39;.&#39;</span>: state = DOTDOT; <span class="keywordflow">break</span>;
<a name="l00172"></a>00172     <span class="keywordflow">case</span> <span class="charliteral">&#39;/&#39;</span>: <span class="keywordflow">return</span> 0;
<a name="l00173"></a>00173     <span class="keywordflow">default</span>: state = PATH;
<a name="l00174"></a>00174     }
<a name="l00175"></a>00175     <span class="keywordflow">break</span>;
<a name="l00176"></a>00176       <span class="keywordflow">case</span> DOTDOT:
<a name="l00177"></a>00177     <span class="keywordflow">if</span> (path[0] == <span class="charliteral">&#39;/&#39;</span>)
<a name="l00178"></a>00178       <span class="keywordflow">return</span> 0;
<a name="l00179"></a>00179     state = PATH;
<a name="l00180"></a>00180     <span class="keywordflow">break</span>;
<a name="l00181"></a>00181       }
<a name="l00182"></a>00182     ++path;
<a name="l00183"></a>00183     --length;
<a name="l00184"></a>00184   }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186   <span class="keywordflow">return</span> state != DOT &amp;&amp; state != DOTDOT;
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="preprocessor">#ifndef HAVE_STRNLEN</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span><span class="keywordtype">size_t</span>
<a name="l00191"></a>00191 strnlen(<span class="keyword">const</span> <span class="keywordtype">char</span> *p, <span class="keywordtype">size_t</span> maxlen) {
<a name="l00192"></a>00192   <span class="keywordtype">size_t</span> n;
<a name="l00193"></a>00193   <span class="keywordflow">for</span> (n = 0; n &lt; maxlen &amp;&amp; p[n]; n++)
<a name="l00194"></a>00194     ;
<a name="l00195"></a>00195   <span class="keywordflow">return</span> n;
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 <span class="preprocessor">#endif</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span>
<a name="l00199"></a>00199 <span class="keywordtype">int</span>
<a name="l00200"></a>00200 resource_wellknown(<a class="code" href="structcoap__context__t.html">coap_context_t</a> *ctx, <a class="code" href="structcoap__resource__t.html">coap_resource_t</a> *resource,
<a name="l00201"></a>00201            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mediatype, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset,
<a name="l00202"></a>00202            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *buflen,
<a name="l00203"></a>00203            <span class="keywordtype">int</span> *finished);
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="preprocessor">#define MIN(x,y) (x) &lt; (y) ? (x) : (y)</span>
<a name="l00206"></a>00206 <span class="preprocessor"></span>
<a name="l00207"></a>00207 <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *
<a name="l00208"></a>00208 handle_get(<a class="code" href="structcoap__context__t.html">coap_context_t</a>  *ctx, <a class="code" href="structcoap__listnode.html">coap_queue_t</a> *node, <span class="keywordtype">void</span> *data) {
<a name="l00209"></a>00209   <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *pdu;
<a name="l00210"></a>00210   <a class="code" href="structcoap__uri__t.html">coap_uri_t</a> uri;
<a name="l00211"></a>00211   <a class="code" href="structcoap__resource__t.html">coap_resource_t</a> *resource;
<a name="l00212"></a>00212   <a class="code" href="unioncoap__opt__t.html">coap_opt_t</a> *block, *tok, *sub;
<a name="l00213"></a>00213   <a class="code" href="structstr.html">str</a> token;
<a name="l00214"></a>00214   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> blklen, blk;
<a name="l00215"></a>00215   <span class="keywordtype">int</span> code, finished = 1;
<a name="l00216"></a>00216   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ls;
<a name="l00217"></a>00217   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration;
<a name="l00218"></a>00218   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> enc;
<a name="l00219"></a>00219   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> mediatype = COAP_MEDIATYPE_ANY;
<a name="l00220"></a>00220   <a class="code" href="structcoap__subscription__t.html">coap_subscription_t</a> *subscription;
<a name="l00221"></a>00221   <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[COAP_MAX_PDU_SIZE];
<a name="l00222"></a>00222   <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> optbuf[4];
<a name="l00223"></a>00223 
<a name="l00224"></a>00224   <span class="keywordflow">if</span> ( !coap_get_request_uri( node-&gt;pdu, &amp;uri ) )
<a name="l00225"></a>00225     <span class="keywordflow">return</span> NULL;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227   <span class="keywordflow">if</span> ( !uri.path.length ) {
<a name="l00228"></a>00228     pdu = new_response(ctx, node, COAP_RESPONSE_200);
<a name="l00229"></a>00229     <span class="keywordflow">if</span> ( !pdu )
<a name="l00230"></a>00230       <span class="keywordflow">return</span> NULL;
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     add_contents( pdu, COAP_MEDIATYPE_TEXT_PLAIN, <span class="keyword">sizeof</span>(INDEX) - 1, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)INDEX );
<a name="l00233"></a>00233     <span class="keywordflow">goto</span> ok;
<a name="l00234"></a>00234   }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236   <span class="comment">/* any other resource */</span>
<a name="l00237"></a>00237   resource = coap_get_resource(ctx, &amp;uri);
<a name="l00238"></a>00238   <span class="keywordflow">if</span> ( !resource )
<a name="l00239"></a>00239     <span class="keywordflow">return</span> new_response(ctx, node, COAP_RESPONSE_404);
<a name="l00240"></a>00240 
<a name="l00241"></a>00241   <span class="comment">/* check if requested mediatypes match */</span>
<a name="l00242"></a>00242   <span class="keywordflow">if</span> ( coap_check_option(node-&gt;pdu, COAP_OPTION_ACCEPT)
<a name="l00243"></a>00243        &amp;&amp; !mediatype_matches(node-&gt;pdu, resource-&gt;mediatype) ) {
<a name="l00244"></a>00244     debug(<span class="stringliteral">&quot;media type mismatch\n&quot;</span>);
<a name="l00245"></a>00245     <span class="keywordflow">return</span> new_response(ctx, node, COAP_RESPONSE_415);
<a name="l00246"></a>00246   }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248   block = coap_check_option(node-&gt;pdu, COAP_OPTION_BLOCK);
<a name="l00249"></a>00249   <span class="keywordflow">if</span> ( block ) {
<a name="l00250"></a>00250     blk = coap_decode_var_bytes(COAP_OPT_VALUE(*block),
<a name="l00251"></a>00251                 COAP_OPT_LENGTH(*block));
<a name="l00252"></a>00252     blklen = 16 &lt;&lt; (blk &amp; 0x07);
<a name="l00253"></a>00253   } <span class="keywordflow">else</span> {
<a name="l00254"></a>00254     blklen = 512; <span class="comment">/* default block size is set to 512 Bytes locally */</span>
<a name="l00255"></a>00255     blk = coap_fls(blklen &gt;&gt; 4) - 1;
<a name="l00256"></a>00256   }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258   <span class="comment">/* invoke callback function to get data representation of requested</span>
<a name="l00259"></a>00259 <span class="comment">     resource */</span>
<a name="l00260"></a>00260   <span class="keywordflow">if</span> ( resource-&gt;<a class="code" href="structcoap__resource__t.html#a621e59a8105e7d7a977714281a6e6967">data</a> ) {
<a name="l00261"></a>00261     mediatype = resource-&gt;mediatype;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263     code = resource-&gt;<a class="code" href="structcoap__resource__t.html#a621e59a8105e7d7a977714281a6e6967">data</a>(&amp;uri, &amp;(node-&gt;pdu-&gt;hdr-&gt;id), &amp;mediatype,
<a name="l00264"></a>00264               (blk &amp; ~0x0f) &lt;&lt; (blk &amp; 0x07), buf, &amp;blklen,
<a name="l00265"></a>00265               &amp;finished, COAP_REQUEST_GET);
<a name="l00266"></a>00266   } <span class="keywordflow">else</span> {
<a name="l00267"></a>00267     <span class="comment">/* check if the well-known URI was requested */</span>
<a name="l00268"></a>00268     <span class="keywordflow">if</span> (memcmp(uri.path.s, COAP_DEFAULT_URI_WELLKNOWN,
<a name="l00269"></a>00269            MIN(uri.path.length, <span class="keyword">sizeof</span>(COAP_DEFAULT_URI_WELLKNOWN) - 1))
<a name="l00270"></a>00270     == 0) {
<a name="l00271"></a>00271       mediatype = resource-&gt;mediatype;
<a name="l00272"></a>00272       code = resource_wellknown(ctx, resource, &amp;mediatype,
<a name="l00273"></a>00273                 (blk &amp; ~0x0f) &lt;&lt; (blk &amp; 0x07), buf, &amp;blklen,
<a name="l00274"></a>00274                 &amp;finished);
<a name="l00275"></a>00275     } <span class="keywordflow">else</span> {
<a name="l00276"></a>00276       <span class="comment">/* no callback available, set code, blklen and finished manually</span>
<a name="l00277"></a>00277 <span class="comment">     (-&gt; empty payload) */</span>
<a name="l00278"></a>00278       code = COAP_RESPONSE_200;
<a name="l00279"></a>00279       blklen = 0;
<a name="l00280"></a>00280       finished = 1;
<a name="l00281"></a>00281     }
<a name="l00282"></a>00282   }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284   <span class="keywordflow">if</span> ( !(pdu = new_response(ctx, node, code)) )
<a name="l00285"></a>00285     <span class="keywordflow">return</span> NULL;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287   <span class="keywordflow">if</span> ( blklen &gt; 0 ) {
<a name="l00288"></a>00288     <span class="comment">/* add content-type */</span>
<a name="l00289"></a>00289     <span class="keywordflow">if</span> ( mediatype != COAP_MEDIATYPE_ANY )
<a name="l00290"></a>00290       coap_add_option(pdu, COAP_OPTION_CONTENT_TYPE, 1, &amp;mediatype);
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     <span class="comment">/* set Max-age option unless resource-&gt;maxage is zero */</span>
<a name="l00293"></a>00293     <span class="keywordflow">if</span> (resource-&gt;maxage) {
<a name="l00294"></a>00294       coap_add_option(pdu, COAP_OPTION_MAXAGE,
<a name="l00295"></a>00295               coap_encode_var_bytes(optbuf, resource-&gt;maxage), optbuf);
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="comment">/* set Etag option unless resource-&gt;etag is zero */</span>
<a name="l00299"></a>00299     <span class="keywordflow">if</span> (*resource-&gt;etag) {
<a name="l00300"></a>00300       coap_add_option(pdu, COAP_OPTION_ETAG,
<a name="l00301"></a>00301               strnlen((<span class="keywordtype">char</span> *)resource-&gt;etag,4), resource-&gt;etag);
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304     <span class="comment">/* handle subscription if requested */</span>
<a name="l00305"></a>00305     sub = coap_check_option( node-&gt;pdu, COAP_OPTION_SUBSCRIPTION );
<a name="l00306"></a>00306     <span class="keywordflow">if</span> ( sub ) {
<a name="l00307"></a>00307       duration = COAP_PSEUDOFP_DECODE_8_4(*COAP_OPT_VALUE(*sub));
<a name="l00308"></a>00308       debug(<span class="stringliteral">&quot;*** add subscription for %d seconds\n&quot;</span>, duration);
<a name="l00309"></a>00309       enc = COAP_PSEUDOFP_ENCODE_8_4_DOWN(duration, ls);
<a name="l00310"></a>00310       coap_add_option(pdu, COAP_OPTION_SUBSCRIPTION, 1, &amp;enc);
<a name="l00311"></a>00311 
<a name="l00312"></a>00312       <span class="comment">/* refresh only if already subscribed */</span>
<a name="l00313"></a>00313       token.length = 0;
<a name="l00314"></a>00314       tok = coap_check_option(node-&gt;pdu, COAP_OPTION_TOKEN);
<a name="l00315"></a>00315       <span class="keywordflow">if</span> (tok) {
<a name="l00316"></a>00316     COAP_SET_STR(&amp;token, COAP_OPT_LENGTH(*tok), COAP_OPT_VALUE(*tok));
<a name="l00317"></a>00317     coap_add_option(pdu, COAP_OPTION_TOKEN,
<a name="l00318"></a>00318             COAP_OPT_LENGTH(*tok),
<a name="l00319"></a>00319             COAP_OPT_VALUE(*tok));
<a name="l00320"></a>00320       }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322       subscription =
<a name="l00323"></a>00323     coap_find_subscription(ctx, coap_uri_hash(&amp;uri), &amp;(node-&gt;remote),
<a name="l00324"></a>00324                    tok ? &amp;token : NULL);
<a name="l00325"></a>00325 
<a name="l00326"></a>00326       <span class="keywordflow">if</span> (subscription) {   <span class="comment">/* refresh existing subscription */</span>
<a name="l00327"></a>00327     subscription-&gt;expires = time(NULL)+duration;
<a name="l00328"></a>00328       } <span class="keywordflow">else</span> {          <span class="comment">/* add new subscription */</span>
<a name="l00329"></a>00329     subscription = coap_new_subscription(ctx, &amp;uri, &amp;(node-&gt;remote),
<a name="l00330"></a>00330                          time(NULL)+duration);
<a name="l00331"></a>00331     <span class="keywordflow">if</span> (subscription) {
<a name="l00332"></a>00332       <span class="keywordflow">if</span> (token.length) {
<a name="l00333"></a>00333         <span class="comment">/* TODO: copy token into subscription-&gt;token */</span>
<a name="l00334"></a>00334         subscription-&gt;token.s = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)coap_malloc(token.length);
<a name="l00335"></a>00335         <span class="keywordflow">if</span> (subscription-&gt;token.s) {
<a name="l00336"></a>00336           subscription-&gt;token.length = token.length;
<a name="l00337"></a>00337           memcpy(subscription-&gt;token.s, token.s, token.length);
<a name="l00338"></a>00338         }
<a name="l00339"></a>00339         <span class="comment">/* FIXME: else error? */</span>
<a name="l00340"></a>00340       }
<a name="l00341"></a>00341       coap_add_subscription(ctx, subscription);
<a name="l00342"></a>00342     }
<a name="l00343"></a>00343       }
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346     <span class="comment">/* add a block option when it has been requested explicitly or</span>
<a name="l00347"></a>00347 <span class="comment">     * there is more data available */</span>
<a name="l00348"></a>00348     <span class="keywordflow">if</span> ( block || !finished ) {
<a name="l00349"></a>00349       blk = (blk &amp; ~0x08) | (!finished &lt;&lt; 3);
<a name="l00350"></a>00350       <span class="comment">/* add block option to PDU */</span>
<a name="l00351"></a>00351       coap_add_option(pdu, COAP_OPTION_BLOCK,
<a name="l00352"></a>00352               coap_encode_var_bytes(optbuf, blk), optbuf);
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <span class="comment">/* We will add contents only when it is not empty. This might lead</span>
<a name="l00356"></a>00356 <span class="comment">     * to problems when this is the last block of a sequence of more</span>
<a name="l00357"></a>00357 <span class="comment">     * than one block. For now, we ignore this problem as it can</span>
<a name="l00358"></a>00358 <span class="comment">     * happen only when the block sizes have changed.</span>
<a name="l00359"></a>00359 <span class="comment">     */</span>
<a name="l00360"></a>00360     <span class="keywordflow">if</span> (!coap_add_data(pdu, blklen, buf)) {
<a name="l00361"></a>00361       <span class="comment">/* FIXME: handle this case -- must send 500 or something */</span>
<a name="l00362"></a>00362     }
<a name="l00363"></a>00363   }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365  ok:
<a name="l00366"></a>00366   <span class="keywordflow">return</span> pdu;
<a name="l00367"></a>00367 }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 <span class="keywordtype">int</span>
<a name="l00370"></a>00370 write_file(<span class="keywordtype">char</span> *filename, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *text, <span class="keywordtype">int</span> length) {
<a name="l00371"></a>00371   FILE *file;
<a name="l00372"></a>00372   ssize_t written;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374   file = fopen(filename, <span class="stringliteral">&quot;w&quot;</span>);
<a name="l00375"></a>00375   <span class="keywordflow">if</span> ( !file ) {
<a name="l00376"></a>00376     perror(<span class="stringliteral">&quot;write_file: fopen&quot;</span>);
<a name="l00377"></a>00377     <span class="keywordflow">return</span> 0;
<a name="l00378"></a>00378   }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380   written = fwrite(text, 1, length, file);
<a name="l00381"></a>00381   fclose(file);
<a name="l00382"></a>00382 
<a name="l00383"></a>00383   <span class="keywordflow">return</span> written;
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *
<a name="l00387"></a>00387 handle_put(<a class="code" href="structcoap__context__t.html">coap_context_t</a>  *ctx, <a class="code" href="structcoap__listnode.html">coap_queue_t</a> *node, <span class="keywordtype">void</span> *data) {
<a name="l00388"></a>00388   <a class="code" href="structcoap__uri__t.html">coap_uri_t</a> uri;
<a name="l00389"></a>00389   <a class="code" href="unioncoap__opt__t.html">coap_opt_t</a> *tok;
<a name="l00390"></a>00390   <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *pdu;
<a name="l00391"></a>00391   <a class="code" href="structcoap__resource__t.html">coap_resource_t</a> *resource;
<a name="l00392"></a>00392   ssize_t written, length;
<a name="l00393"></a>00393   <span class="keyword">struct </span>stat statbuf;
<a name="l00394"></a>00394   <span class="keyword">static</span> <span class="keywordtype">char</span> filename[FILENAME_MAX+1];
<a name="l00395"></a>00395 
<a name="l00396"></a>00396   <span class="keywordflow">if</span> ( !coap_get_request_uri( node-&gt;pdu, &amp;uri ) )
<a name="l00397"></a>00397     <span class="keywordflow">return</span> NULL;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399   <span class="comment">/* we do not want to create the resource if not available */</span>
<a name="l00400"></a>00400   <span class="keywordflow">if</span> ( !(resource = coap_get_resource(ctx, &amp;uri)) )
<a name="l00401"></a>00401     <span class="keywordflow">return</span> new_response(ctx, node, COAP_RESPONSE_404);
<a name="l00402"></a>00402 
<a name="l00403"></a>00403   <span class="keywordflow">if</span> (!resource-&gt;writable)
<a name="l00404"></a>00404     <span class="keywordflow">return</span> new_response(ctx, node, COAP_RESPONSE_400);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406   <span class="keywordflow">if</span> ( !(pdu = new_response(ctx, node, COAP_RESPONSE_200)) )
<a name="l00407"></a>00407     <span class="keywordflow">return</span> NULL;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409   <span class="comment">/* create a zero-terminated string */</span>
<a name="l00410"></a>00410   memcpy(filename, uri.path.s, uri.path.length);
<a name="l00411"></a>00411   filename[uri.path.length] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413   length = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)node-&gt;pdu-&gt;hdr + node-&gt;pdu-&gt;length - node-&gt;pdu-&gt;data;
<a name="l00414"></a>00414   written = write_file(filename, node-&gt;pdu-&gt;data, length);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416   <span class="comment">/* set etag from file&#39;s modification time (byte-order does not care) */</span>
<a name="l00417"></a>00417   <span class="keywordflow">if</span> ( (stat(filename, &amp;statbuf) == 0) &amp;&amp;
<a name="l00418"></a>00418        S_ISREG(statbuf.st_mode) ) {
<a name="l00419"></a>00419     memcpy(resource-&gt;etag, &amp;statbuf.st_mtime, <span class="keyword">sizeof</span>(resource-&gt;etag));
<a name="l00420"></a>00420   } <span class="keywordflow">else</span> {          <span class="comment">/* clear etag */</span>
<a name="l00421"></a>00421     *resource-&gt;etag = 0;
<a name="l00422"></a>00422   }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424   <span class="keywordflow">if</span> (written &lt; length)
<a name="l00425"></a>00425     <span class="keywordflow">return</span> new_response(ctx, node, COAP_RESPONSE_500);
<a name="l00426"></a>00426 
<a name="l00427"></a>00427   tok = coap_check_option(node-&gt;pdu, COAP_OPTION_CONTENT_TYPE);
<a name="l00428"></a>00428   resource-&gt;mediatype = tok ? *COAP_OPT_VALUE(*tok) : COAP_MEDIATYPE_ANY;
<a name="l00429"></a>00429   resource-&gt;dirty = 1;      <span class="comment">/* mark for notification of observers */</span>
<a name="l00430"></a>00430   <span class="keywordflow">return</span> pdu;
<a name="l00431"></a>00431 }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 <span class="keywordtype">int</span>
<a name="l00434"></a>00434 resource_from_file(<a class="code" href="structcoap__uri__t.html">coap_uri_t</a> *uri, coap_tid_t  *<span class="keywordtype">id</span>,
<a name="l00435"></a>00435            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mediatype, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset,
<a name="l00436"></a>00436            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *buflen,
<a name="l00437"></a>00437            <span class="keywordtype">int</span> *finished, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> method);
<a name="l00438"></a>00438 
<a name="l00439"></a>00439 <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *
<a name="l00440"></a>00440 handle_post(<a class="code" href="structcoap__context__t.html">coap_context_t</a>  *ctx, <a class="code" href="structcoap__listnode.html">coap_queue_t</a> *node, <span class="keywordtype">void</span> *data) {
<a name="l00441"></a>00441   <a class="code" href="structcoap__uri__t.html">coap_uri_t</a> uri;
<a name="l00442"></a>00442   <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *pdu;
<a name="l00443"></a>00443   <a class="code" href="structcoap__resource__t.html">coap_resource_t</a> *r;
<a name="l00444"></a>00444   <a class="code" href="unioncoap__opt__t.html">coap_opt_t</a> *tok;
<a name="l00445"></a>00445   ssize_t written, length;
<a name="l00446"></a>00446   <span class="keywordtype">int</span> namelen;
<a name="l00447"></a>00447   <span class="keywordtype">char</span> name[60];
<a name="l00448"></a>00448   <span class="keyword">struct </span>stat statbuf;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450   <span class="keywordflow">if</span> ( !coap_get_request_uri( node-&gt;pdu, &amp;uri ) )
<a name="l00451"></a>00451     <span class="keywordflow">return</span> NULL;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453   <span class="comment">/* existing stuff can be handled using put for now */</span>
<a name="l00454"></a>00454   <span class="keywordflow">if</span> (coap_get_resource(ctx, &amp;uri))
<a name="l00455"></a>00455     <span class="keywordflow">return</span> handle_put(ctx, node, data);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457   <span class="comment">/* create new resource */</span>
<a name="l00458"></a>00458   <span class="keywordflow">if</span> ( !(r = coap_malloc( <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>) )))
<a name="l00459"></a>00459     <span class="keywordflow">return</span> new_response(ctx, node, COAP_RESPONSE_500);
<a name="l00460"></a>00460 
<a name="l00461"></a>00461   tok = coap_check_option(node-&gt;pdu, COAP_OPTION_CONTENT_TYPE);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463   <span class="comment">/* Create a new resource to store the given contents in the local</span>
<a name="l00464"></a>00464 <span class="comment">   * file system. We restrict the storage area to DATASINK_PREFIX.</span>
<a name="l00465"></a>00465 <span class="comment">   */</span>
<a name="l00466"></a>00466   memset(name, 0, <span class="keyword">sizeof</span>(name));
<a name="l00467"></a>00467   namelen = snprintf(name, <span class="keyword">sizeof</span>(name)-1, DATASINK_PREFIX <span class="stringliteral">&quot;%lX&quot;</span>,
<a name="l00468"></a>00468              coap_uri_hash(&amp;uri));
<a name="l00469"></a>00469 
<a name="l00470"></a>00470   r-&gt;uri = coap_new_uri((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)name, namelen);
<a name="l00471"></a>00471   r-&gt;name = coap_new_string(uri.path.length);
<a name="l00472"></a>00472   <span class="keywordflow">if</span> (r-&gt;name) {
<a name="l00473"></a>00473     r-&gt;name-&gt;length = uri.path.length;
<a name="l00474"></a>00474     memcpy(r-&gt;name-&gt;s, uri.path.s, r-&gt;name-&gt;length);
<a name="l00475"></a>00475   }
<a name="l00476"></a>00476 
<a name="l00477"></a>00477   r-&gt;mediatype = tok ? *COAP_OPT_VALUE(*tok) : COAP_MEDIATYPE_ANY;
<a name="l00478"></a>00478   r-&gt;dirty = 1;
<a name="l00479"></a>00479   r-&gt;writable = 1;
<a name="l00480"></a>00480   r-&gt;<a class="code" href="structcoap__resource__t.html#a621e59a8105e7d7a977714281a6e6967">data</a> = resource_from_file;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482   <span class="comment">/* we know that r-&gt;uri.s is zero-terminated */</span>
<a name="l00483"></a>00483   length =
<a name="l00484"></a>00484     (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)node-&gt;pdu-&gt;hdr + node-&gt;pdu-&gt;length - node-&gt;pdu-&gt;data;
<a name="l00485"></a>00485   written = write_file((<span class="keywordtype">char</span> *)r-&gt;uri-&gt;path.s, node-&gt;pdu-&gt;data, length);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487   <span class="comment">/* set etag from file&#39;s modification time (byte-order does not care) */</span>
<a name="l00488"></a>00488   <span class="keywordflow">if</span> ( (stat((<span class="keywordtype">char</span> *)r-&gt;uri-&gt;path.s, &amp;statbuf) == 0) &amp;&amp;
<a name="l00489"></a>00489        S_ISREG(statbuf.st_mode) ) {
<a name="l00490"></a>00490     memcpy(r-&gt;etag, &amp;statbuf.st_mtime, <span class="keyword">sizeof</span>(r-&gt;etag));
<a name="l00491"></a>00491   } <span class="keywordflow">else</span> {          <span class="comment">/* clear etag */</span>
<a name="l00492"></a>00492     *r-&gt;etag = 0;
<a name="l00493"></a>00493   }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495   <span class="keywordflow">if</span> (written &lt; length) {
<a name="l00496"></a>00496     coap_free(r);
<a name="l00497"></a>00497     <span class="keywordflow">return</span> new_response(ctx, node, COAP_RESPONSE_500);
<a name="l00498"></a>00498   } <span class="keywordflow">else</span>
<a name="l00499"></a>00499     coap_add_resource(ctx, r);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501   <span class="comment">/* create the response */</span>
<a name="l00502"></a>00502   pdu = new_response(ctx, node, COAP_RESPONSE_201);
<a name="l00503"></a>00503 
<a name="l00504"></a>00504   <span class="comment">/* add location header */</span>
<a name="l00505"></a>00505   coap_add_option(pdu, COAP_OPTION_LOCATION,
<a name="l00506"></a>00506           namelen, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)name);
<a name="l00507"></a>00507 
<a name="l00508"></a>00508   <span class="comment">/* we do not need the request URI, only a token, if specified */</span>
<a name="l00509"></a>00509 
<a name="l00510"></a>00510   tok = coap_check_option(node-&gt;pdu, COAP_OPTION_TOKEN);
<a name="l00511"></a>00511   <span class="keywordflow">if</span> (tok)
<a name="l00512"></a>00512     coap_add_option(pdu, COAP_OPTION_TOKEN,
<a name="l00513"></a>00513             COAP_OPT_LENGTH(*tok), COAP_OPT_VALUE(*tok));
<a name="l00514"></a>00514 
<a name="l00515"></a>00515   <span class="keywordflow">return</span> pdu;
<a name="l00516"></a>00516 }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518 <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *
<a name="l00519"></a>00519 handle_delete(<a class="code" href="structcoap__context__t.html">coap_context_t</a>  *ctx, <a class="code" href="structcoap__listnode.html">coap_queue_t</a> *node, <span class="keywordtype">void</span> *data) {
<a name="l00520"></a>00520   <a class="code" href="structcoap__uri__t.html">coap_uri_t</a> uri;
<a name="l00521"></a>00521   <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *pdu;
<a name="l00522"></a>00522   <a class="code" href="structcoap__resource__t.html">coap_resource_t</a> *r;
<a name="l00523"></a>00523   <a class="code" href="unioncoap__opt__t.html">coap_opt_t</a> *tok;
<a name="l00524"></a>00524   <span class="keyword">static</span> <span class="keywordtype">char</span> filename[FILENAME_MAX+1];
<a name="l00525"></a>00525 
<a name="l00526"></a>00526   <span class="keywordflow">if</span> ( !coap_get_request_uri( node-&gt;pdu, &amp;uri ) )
<a name="l00527"></a>00527     <span class="keywordflow">return</span> NULL;
<a name="l00528"></a>00528 
<a name="l00529"></a>00529   r = coap_get_resource(ctx, &amp;uri);
<a name="l00530"></a>00530   <span class="keywordflow">if</span> (!r)
<a name="l00531"></a>00531     <span class="keywordflow">return</span> new_response(ctx, node, COAP_RESPONSE_404);
<a name="l00532"></a>00532 
<a name="l00533"></a>00533   <span class="keywordflow">if</span> (!r-&gt;writable) {
<a name="l00534"></a>00534     debug(<span class="stringliteral">&quot;tried to remove resource that is read-only\n&quot;</span>);
<a name="l00535"></a>00535     pdu = new_response(ctx, node, COAP_RESPONSE_400);
<a name="l00536"></a>00536     coap_add_data(pdu, 9, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<span class="stringliteral">&quot;forbidden&quot;</span>);
<a name="l00537"></a>00537     <span class="keywordflow">return</span> pdu;
<a name="l00538"></a>00538   }
<a name="l00539"></a>00539 
<a name="l00540"></a>00540   <span class="keywordflow">if</span> (FILENAME_MAX &lt; uri.path.length)
<a name="l00541"></a>00541     <span class="keywordflow">return</span> new_response(ctx, node, COAP_RESPONSE_500);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543   memcpy(filename, uri.path.s, uri.path.length);
<a name="l00544"></a>00544   filename[uri.path.length] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546   debug(<span class="stringliteral">&quot;unlink %s\n&quot;</span>, filename);
<a name="l00547"></a>00547   unlink(filename);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549   <span class="comment">/* create the response */</span>
<a name="l00550"></a>00550   pdu = new_response(ctx, node, COAP_RESPONSE_200);
<a name="l00551"></a>00551 
<a name="l00552"></a>00552   <span class="keywordflow">if</span> (uri.na.length)
<a name="l00553"></a>00553     coap_add_option(pdu, COAP_OPTION_URI_AUTHORITY,
<a name="l00554"></a>00554             uri.na.length, uri.na.s);
<a name="l00555"></a>00555 
<a name="l00556"></a>00556   <span class="keywordflow">if</span> (uri.path.length)
<a name="l00557"></a>00557     coap_add_option(pdu, COAP_OPTION_URI_PATH,
<a name="l00558"></a>00558             uri.path.length, uri.path.s);
<a name="l00559"></a>00559 
<a name="l00560"></a>00560   tok = coap_check_option(node-&gt;pdu, COAP_OPTION_TOKEN);
<a name="l00561"></a>00561   <span class="keywordflow">if</span> (tok)
<a name="l00562"></a>00562     coap_add_option(pdu, COAP_OPTION_TOKEN,
<a name="l00563"></a>00563             COAP_OPT_LENGTH(*tok), COAP_OPT_VALUE(*tok));
<a name="l00564"></a>00564 
<a name="l00565"></a>00565   <span class="keywordflow">if</span> (uri.query.length)
<a name="l00566"></a>00566     coap_add_option(pdu, COAP_OPTION_URI_QUERY,
<a name="l00567"></a>00567             uri.query.length, uri.query.s);
<a name="l00568"></a>00568 
<a name="l00569"></a>00569   coap_delete_resource(ctx, coap_uri_hash(&amp;uri));
<a name="l00570"></a>00570 
<a name="l00571"></a>00571   <span class="keywordflow">return</span> pdu;
<a name="l00572"></a>00572 }
<a name="l00573"></a>00573 
<a name="l00574"></a>00574 <span class="keywordtype">void</span>
<a name="l00575"></a>00575 message_handler(<a class="code" href="structcoap__context__t.html">coap_context_t</a>  *ctx, <a class="code" href="structcoap__listnode.html">coap_queue_t</a> *node, <span class="keywordtype">void</span> *data) {
<a name="l00576"></a>00576   <a class="code" href="structcoap__pdu__t.html">coap_pdu_t</a> *pdu = NULL;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l00579"></a>00579 <span class="preprocessor"></span>  debug(<span class="stringliteral">&quot;** process pdu: &quot;</span>);
<a name="l00580"></a>00580   coap_show_pdu( node-&gt;pdu );
<a name="l00581"></a>00581 <span class="preprocessor">#endif</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span>
<a name="l00583"></a>00583   <span class="keywordflow">if</span> ( node-&gt;pdu-&gt;hdr-&gt;version != COAP_DEFAULT_VERSION ) {
<a name="l00584"></a>00584     debug(<span class="stringliteral">&quot;dropped packet with unknown version %u\n&quot;</span>, node-&gt;pdu-&gt;hdr-&gt;version);
<a name="l00585"></a>00585     <span class="keywordflow">return</span>;
<a name="l00586"></a>00586   }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588   <span class="keywordflow">switch</span> (node-&gt;pdu-&gt;hdr-&gt;code) {
<a name="l00589"></a>00589   <span class="keywordflow">case</span> COAP_REQUEST_GET :
<a name="l00590"></a>00590     pdu = handle_get(ctx, node, data);
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     <span class="keywordflow">if</span> ( !pdu &amp;&amp; node-&gt;pdu-&gt;hdr-&gt;type == COAP_MESSAGE_CON )
<a name="l00593"></a>00593       pdu = new_rst( ctx, node, COAP_RESPONSE_500 );
<a name="l00594"></a>00594     <span class="keywordflow">break</span>;
<a name="l00595"></a>00595   <span class="keywordflow">case</span> COAP_REQUEST_PUT:
<a name="l00596"></a>00596     pdu = handle_put(ctx, node, data);
<a name="l00597"></a>00597     <span class="keywordflow">if</span> ( !pdu &amp;&amp; node-&gt;pdu-&gt;hdr-&gt;type == COAP_MESSAGE_CON )
<a name="l00598"></a>00598       pdu = new_response( ctx, node, COAP_RESPONSE_400 );
<a name="l00599"></a>00599     <span class="keywordflow">break</span>;
<a name="l00600"></a>00600   <span class="keywordflow">case</span> COAP_REQUEST_POST:
<a name="l00601"></a>00601     pdu = handle_post(ctx, node, data);
<a name="l00602"></a>00602     <span class="keywordflow">if</span> ( !pdu &amp;&amp; node-&gt;pdu-&gt;hdr-&gt;type == COAP_MESSAGE_CON )
<a name="l00603"></a>00603       pdu = new_response( ctx, node, COAP_RESPONSE_400 );
<a name="l00604"></a>00604     <span class="keywordflow">break</span>;
<a name="l00605"></a>00605   <span class="keywordflow">case</span> COAP_REQUEST_DELETE:
<a name="l00606"></a>00606     pdu = handle_delete(ctx, node, data);
<a name="l00607"></a>00607     <span class="keywordflow">if</span> ( !pdu &amp;&amp; node-&gt;pdu-&gt;hdr-&gt;type == COAP_MESSAGE_CON )
<a name="l00608"></a>00608       pdu = new_response( ctx, node, COAP_RESPONSE_400 );
<a name="l00609"></a>00609     <span class="keywordflow">break</span>;
<a name="l00610"></a>00610   <span class="keywordflow">default</span>:
<a name="l00611"></a>00611     <span class="keywordflow">if</span> ( node-&gt;pdu-&gt;hdr-&gt;type == COAP_MESSAGE_CON ) {
<a name="l00612"></a>00612       <span class="keywordflow">if</span> ( node-&gt;pdu-&gt;hdr-&gt;code &gt;= COAP_RESPONSE_100 )
<a name="l00613"></a>00613     pdu = new_rst( ctx, node, COAP_RESPONSE_500 );
<a name="l00614"></a>00614       <span class="keywordflow">else</span> {
<a name="l00615"></a>00615     debug(<span class="stringliteral">&quot;request method not implemented: %u\n&quot;</span>, node-&gt;pdu-&gt;hdr-&gt;code);
<a name="l00616"></a>00616     pdu = new_rst( ctx, node, COAP_RESPONSE_405 );
<a name="l00617"></a>00617       }
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619   }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621   <span class="keywordflow">if</span> ( pdu &amp;&amp; coap_send( ctx, &amp;node-&gt;remote, pdu ) == COAP_INVALID_TID ) {
<a name="l00622"></a>00622     debug(<span class="stringliteral">&quot;message_handler: error sending reponse&quot;</span>);
<a name="l00623"></a>00623     coap_delete_pdu(pdu);
<a name="l00624"></a>00624   }
<a name="l00625"></a>00625 
<a name="l00626"></a>00626 }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628 <span class="keywordtype">void</span>
<a name="l00629"></a>00629 usage( <span class="keyword">const</span> <span class="keywordtype">char</span> *program, <span class="keyword">const</span> <span class="keywordtype">char</span> *version) {
<a name="l00630"></a>00630   <span class="keyword">const</span> <span class="keywordtype">char</span> *p;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632   p = strrchr( program, <span class="charliteral">&#39;/&#39;</span> );
<a name="l00633"></a>00633   <span class="keywordflow">if</span> ( p )
<a name="l00634"></a>00634     program = ++p;
<a name="l00635"></a>00635 
<a name="l00636"></a>00636   fprintf( stderr, <span class="stringliteral">&quot;%s v%s -- a small CoAP implementation\n&quot;</span>
<a name="l00637"></a>00637        <span class="stringliteral">&quot;(c) 2010 Olaf Bergmann &lt;bergmann@tzi.org&gt;\n\n&quot;</span>
<a name="l00638"></a>00638        <span class="stringliteral">&quot;usage: %s [-g group] [-p port] URI\n\n&quot;</span>
<a name="l00639"></a>00639        <span class="stringliteral">&quot;\tURI can be an absolute or relative coap URI,\n&quot;</span>
<a name="l00640"></a>00640        <span class="stringliteral">&quot;\t-g group\tjoin the given multicast group\n&quot;</span>
<a name="l00641"></a>00641        <span class="stringliteral">&quot;\t-p port\t\tlisten on specified port\n&quot;</span>,
<a name="l00642"></a>00642        program, version, program );
<a name="l00643"></a>00643 }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645 <span class="keywordtype">int</span>
<a name="l00646"></a>00646 join( <a class="code" href="structcoap__context__t.html">coap_context_t</a> *ctx, <span class="keywordtype">char</span> *group_name ){
<a name="l00647"></a>00647   <span class="keyword">struct </span>ipv6_mreq mreq;
<a name="l00648"></a>00648   <span class="keyword">struct </span>addrinfo   *reslocal = NULL, *resmulti = NULL, hints, *ainfo;
<a name="l00649"></a>00649   <span class="keywordtype">int</span> result = -1;
<a name="l00650"></a>00650 
<a name="l00651"></a>00651   <span class="comment">/* we have to resolve the link-local interface to get the interface id */</span>
<a name="l00652"></a>00652   memset(&amp;hints, 0, <span class="keyword">sizeof</span>(hints));
<a name="l00653"></a>00653   hints.ai_family = AF_INET6;
<a name="l00654"></a>00654   hints.ai_socktype = SOCK_DGRAM;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656   result = getaddrinfo(<span class="stringliteral">&quot;::&quot;</span>, NULL, &amp;hints, &amp;reslocal);
<a name="l00657"></a>00657   <span class="keywordflow">if</span> ( result &lt; 0 ) {
<a name="l00658"></a>00658     perror(<span class="stringliteral">&quot;join: cannot resolve link-local interface&quot;</span>);
<a name="l00659"></a>00659     <span class="keywordflow">goto</span> finish;
<a name="l00660"></a>00660   }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662   <span class="comment">/* get the first suitable interface identifier */</span>
<a name="l00663"></a>00663   <span class="keywordflow">for</span> (ainfo = reslocal; ainfo != NULL; ainfo = ainfo-&gt;ai_next) {
<a name="l00664"></a>00664     <span class="keywordflow">if</span> ( ainfo-&gt;ai_family == AF_INET6 ) {
<a name="l00665"></a>00665       mreq.ipv6mr_interface =
<a name="l00666"></a>00666           ((<span class="keyword">struct </span>sockaddr_in6 *)ainfo-&gt;ai_addr)-&gt;sin6_scope_id;
<a name="l00667"></a>00667       <span class="keywordflow">break</span>;
<a name="l00668"></a>00668     }
<a name="l00669"></a>00669   }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671   memset(&amp;hints, 0, <span class="keyword">sizeof</span>(hints));
<a name="l00672"></a>00672   hints.ai_family = AF_INET6;
<a name="l00673"></a>00673   hints.ai_socktype = SOCK_DGRAM;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675   <span class="comment">/* resolve the multicast group address */</span>
<a name="l00676"></a>00676   result = getaddrinfo(group_name, NULL, &amp;hints, &amp;resmulti);
<a name="l00677"></a>00677 
<a name="l00678"></a>00678   <span class="keywordflow">if</span> ( result &lt; 0 ) {
<a name="l00679"></a>00679     perror(<span class="stringliteral">&quot;join: cannot resolve multicast address&quot;</span>);
<a name="l00680"></a>00680     <span class="keywordflow">goto</span> finish;
<a name="l00681"></a>00681   }
<a name="l00682"></a>00682 
<a name="l00683"></a>00683   <span class="keywordflow">for</span> (ainfo = resmulti; ainfo != NULL; ainfo = ainfo-&gt;ai_next) {
<a name="l00684"></a>00684     <span class="keywordflow">if</span> ( ainfo-&gt;ai_family == AF_INET6 ) {
<a name="l00685"></a>00685       mreq.ipv6mr_multiaddr =
<a name="l00686"></a>00686     ((<span class="keyword">struct </span>sockaddr_in6 *)ainfo-&gt;ai_addr)-&gt;sin6_addr;
<a name="l00687"></a>00687       <span class="keywordflow">break</span>;
<a name="l00688"></a>00688     }
<a name="l00689"></a>00689   }
<a name="l00690"></a>00690 
<a name="l00691"></a>00691   result = setsockopt( ctx-&gt;sockfd, IPPROTO_IPV6, IPV6_JOIN_GROUP,
<a name="l00692"></a>00692                (<span class="keywordtype">char</span> *)&amp;mreq, <span class="keyword">sizeof</span>(mreq) );
<a name="l00693"></a>00693   <span class="keywordflow">if</span> ( result &lt; 0 )
<a name="l00694"></a>00694     perror(<span class="stringliteral">&quot;join: setsockopt&quot;</span>);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696  finish:
<a name="l00697"></a>00697   freeaddrinfo(resmulti);
<a name="l00698"></a>00698   freeaddrinfo(reslocal);
<a name="l00699"></a>00699 
<a name="l00700"></a>00700   <span class="keywordflow">return</span> result;
<a name="l00701"></a>00701 }
<a name="l00702"></a>00702 
<a name="l00703"></a>00703 <span class="keywordtype">int</span>
<a name="l00704"></a>00704 print_link(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a> *resource, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> buflen) {
<a name="l00705"></a>00705   <span class="keywordtype">size_t</span> n = 0;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707   assert(resource);
<a name="l00708"></a>00708   assert(buf);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710   <span class="keywordflow">if</span> (buflen &lt; resource-&gt;uri-&gt;path.length + 3)
<a name="l00711"></a>00711     <span class="keywordflow">return</span> -1;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713   <span class="comment">/* FIXME: calculate maximum length and return if longer than buflen */</span>
<a name="l00714"></a>00714   buf[n++] = <span class="charliteral">&#39;&lt;&#39;</span>; buf[n++] = <span class="charliteral">&#39;/&#39;</span>;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716   memcpy(buf + n, resource-&gt;uri-&gt;path.s, resource-&gt;uri-&gt;path.length);
<a name="l00717"></a>00717 
<a name="l00718"></a>00718   n += resource-&gt;uri-&gt;path.length;
<a name="l00719"></a>00719   buf[n++] = <span class="charliteral">&#39;&gt;&#39;</span>;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721   <span class="keywordflow">if</span> (resource-&gt;mediatype != COAP_MEDIATYPE_ANY) {
<a name="l00722"></a>00722     <span class="keywordflow">if</span> (buflen - n &lt; 7)     <span class="comment">/* mediatype is at most 3 digits */</span>
<a name="l00723"></a>00723       <span class="keywordflow">return</span> -1;
<a name="l00724"></a>00724     n += snprintf((<span class="keywordtype">char</span> *)(buf + n), buflen - n, <span class="stringliteral">&quot;;ct=%d&quot;</span>,
<a name="l00725"></a>00725           resource-&gt;mediatype);
<a name="l00726"></a>00726   }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728   <span class="keywordflow">if</span> (resource-&gt;name) {
<a name="l00729"></a>00729     <span class="keywordflow">if</span> (buflen - n &lt; resource-&gt;name-&gt;length + 5) <span class="comment">/* include trailing quote */</span>
<a name="l00730"></a>00730       <span class="keywordflow">return</span> -1;
<a name="l00731"></a>00731 
<a name="l00732"></a>00732     memcpy(buf + n, <span class="stringliteral">&quot;;n=\&quot;&quot;</span>, 4);
<a name="l00733"></a>00733     n += 4;
<a name="l00734"></a>00734     memcpy(buf + n, resource-&gt;name-&gt;s, resource-&gt;name-&gt;length);
<a name="l00735"></a>00735     n += resource-&gt;name-&gt;length;
<a name="l00736"></a>00736 
<a name="l00737"></a>00737     <span class="keywordflow">if</span> (!resource-&gt;writable) {
<a name="l00738"></a>00738       <span class="keywordflow">if</span> (buflen - n &lt; 12)
<a name="l00739"></a>00739     <span class="keywordflow">return</span> -1;
<a name="l00740"></a>00740 
<a name="l00741"></a>00741       n += snprintf((<span class="keywordtype">char</span> *)(buf + n), buflen - n, <span class="stringliteral">&quot; (read-only)&quot;</span>);
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     buf[n++] = <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l00745"></a>00745   }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747   <span class="keywordflow">return</span>  n;
<a name="l00748"></a>00748 }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750 <span class="keywordtype">int</span>
<a name="l00751"></a>00751 resource_wellknown(<a class="code" href="structcoap__context__t.html">coap_context_t</a> *ctx,
<a name="l00752"></a>00752            <a class="code" href="structcoap__resource__t.html">coap_resource_t</a> *resource,
<a name="l00753"></a>00753            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mediatype, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset,
<a name="l00754"></a>00754            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *buflen,
<a name="l00755"></a>00755            <span class="keywordtype">int</span> *finished) {
<a name="l00756"></a>00756 <span class="preprocessor">#define RESOURCE_BUFLEN 4000</span>
<a name="l00757"></a>00757 <span class="preprocessor"></span>  <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> resources[RESOURCE_BUFLEN];
<a name="l00758"></a>00758   <span class="keywordtype">size_t</span> maxlen = 0;
<a name="l00759"></a>00759   <span class="keywordtype">int</span> n;
<a name="l00760"></a>00760   <a class="code" href="structcoap__linkedlistnode.html">coap_list_t</a> *node;
<a name="l00761"></a>00761 
<a name="l00762"></a>00762   assert(ctx); assert(resource);
<a name="l00763"></a>00763 
<a name="l00764"></a>00764   <span class="comment">/* first, update the link-set */</span>
<a name="l00765"></a>00765   <span class="keywordflow">for</span> (node = ctx-&gt;resources; node; node = node-&gt;next) {
<a name="l00766"></a>00766     n = print_link(COAP_RESOURCE(node), resources + maxlen,
<a name="l00767"></a>00767            RESOURCE_BUFLEN - maxlen);
<a name="l00768"></a>00768     <span class="keywordflow">if</span> (n &lt;= 0) {           <span class="comment">/* error */</span>
<a name="l00769"></a>00769       debug(<span class="stringliteral">&quot;resource description too long, truncating\n&quot;</span>);
<a name="l00770"></a>00770       resources[maxlen] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00771"></a>00771       <span class="keywordflow">break</span>;
<a name="l00772"></a>00772     }
<a name="l00773"></a>00773     maxlen += n;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775     <span class="keywordflow">if</span> (node-&gt;next)         <span class="comment">/* check if another entry follows */</span>
<a name="l00776"></a>00776       resources[maxlen++] = <span class="charliteral">&#39;,&#39;</span>;
<a name="l00777"></a>00777     <span class="keywordflow">else</span>            <span class="comment">/* no next, terminate string */</span>
<a name="l00778"></a>00778       resources[maxlen] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00779"></a>00779   }
<a name="l00780"></a>00780 
<a name="l00781"></a>00781   *finished = 1;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783   <span class="keywordflow">switch</span> (*mediatype) {
<a name="l00784"></a>00784   <span class="keywordflow">case</span> COAP_MEDIATYPE_ANY :
<a name="l00785"></a>00785   <span class="keywordflow">case</span> COAP_MEDIATYPE_APPLICATION_LINK_FORMAT :
<a name="l00786"></a>00786     *mediatype = COAP_MEDIATYPE_APPLICATION_LINK_FORMAT;
<a name="l00787"></a>00787     <span class="keywordflow">break</span>;
<a name="l00788"></a>00788   <span class="keywordflow">default</span> :
<a name="l00789"></a>00789     *buflen = 0;
<a name="l00790"></a>00790     <span class="keywordflow">return</span> COAP_RESPONSE_415;
<a name="l00791"></a>00791   }
<a name="l00792"></a>00792 
<a name="l00793"></a>00793   <span class="keywordflow">if</span> ( offset &gt; maxlen ) {
<a name="l00794"></a>00794     *buflen = 0;
<a name="l00795"></a>00795     <span class="keywordflow">return</span> COAP_RESPONSE_400;
<a name="l00796"></a>00796   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( offset + *buflen &gt; maxlen )
<a name="l00797"></a>00797     *buflen = maxlen - offset;
<a name="l00798"></a>00798 
<a name="l00799"></a>00799   memcpy(buf, resources + offset, *buflen);
<a name="l00800"></a>00800 
<a name="l00801"></a>00801   *finished = offset + *buflen == maxlen;
<a name="l00802"></a>00802   <span class="keywordflow">return</span> COAP_RESPONSE_200;
<a name="l00803"></a>00803 }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805 <span class="keywordtype">int</span>
<a name="l00806"></a>00806 resource_time(<a class="code" href="structcoap__uri__t.html">coap_uri_t</a> *uri, coap_tid_t  *<span class="keywordtype">id</span>,
<a name="l00807"></a>00807           <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mediatype, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset,
<a name="l00808"></a>00808           <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *buflen,
<a name="l00809"></a>00809           <span class="keywordtype">int</span> *finished, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> method) {
<a name="l00810"></a>00810   <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> b[400];
<a name="l00811"></a>00811   <span class="keywordtype">size_t</span> maxlen;
<a name="l00812"></a>00812   time_t now;
<a name="l00813"></a>00813   <span class="keyword">struct </span>tm *tlocal;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815   time(&amp;now);
<a name="l00816"></a>00816   tlocal = localtime(&amp;now);
<a name="l00817"></a>00817 
<a name="l00818"></a>00818   *finished = 1;
<a name="l00819"></a>00819 
<a name="l00820"></a>00820   <span class="keywordflow">if</span> ( !tlocal ) {
<a name="l00821"></a>00821     *buflen = 0;
<a name="l00822"></a>00822     <span class="keywordflow">return</span> COAP_RESPONSE_500;
<a name="l00823"></a>00823   }
<a name="l00824"></a>00824 
<a name="l00825"></a>00825   <span class="keywordflow">switch</span> (*mediatype) {
<a name="l00826"></a>00826   <span class="keywordflow">case</span> COAP_MEDIATYPE_ANY :
<a name="l00827"></a>00827   <span class="keywordflow">case</span> COAP_MEDIATYPE_TEXT_PLAIN :
<a name="l00828"></a>00828     *mediatype = COAP_MEDIATYPE_TEXT_PLAIN;
<a name="l00829"></a>00829     maxlen = strftime(resource_buf, <span class="keyword">sizeof</span>(b), <span class="stringliteral">&quot;%b %d %H:%M:%S&quot;</span>, tlocal);
<a name="l00830"></a>00830     <span class="keywordflow">break</span>;
<a name="l00831"></a>00831   <span class="keywordflow">case</span> COAP_MEDIATYPE_TEXT_XML :
<a name="l00832"></a>00832   <span class="keywordflow">case</span> COAP_MEDIATYPE_APPLICATION_XML :
<a name="l00833"></a>00833     maxlen = strftime(resource_buf, <span class="keyword">sizeof</span>(b), <span class="stringliteral">&quot;&lt;datetime&gt;\n  &lt;date&gt;%Y-%m-%d&lt;/date&gt;\n  &lt;time&gt;%H:%M:%S&lt;/time&gt;\n  &lt;/tz&gt;%S&lt;/tz&gt;\n&lt;/datetime&gt;&quot;</span>, tlocal);
<a name="l00834"></a>00834     <span class="keywordflow">break</span>;
<a name="l00835"></a>00835   <span class="keywordflow">default</span> :
<a name="l00836"></a>00836     *buflen = 0;
<a name="l00837"></a>00837     <span class="keywordflow">return</span> COAP_RESPONSE_415;
<a name="l00838"></a>00838   }
<a name="l00839"></a>00839 
<a name="l00840"></a>00840   <span class="keywordflow">if</span> ( offset &gt; maxlen ) {
<a name="l00841"></a>00841     *buflen = 0;
<a name="l00842"></a>00842     <span class="keywordflow">return</span> COAP_RESPONSE_400;
<a name="l00843"></a>00843   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( offset + *buflen &gt; maxlen )
<a name="l00844"></a>00844     *buflen = maxlen - offset;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846   memcpy(buf, resource_buf + offset, *buflen);
<a name="l00847"></a>00847 
<a name="l00848"></a>00848   *finished =offset + *buflen == maxlen;
<a name="l00849"></a>00849   <span class="keywordflow">return</span> COAP_RESPONSE_200;
<a name="l00850"></a>00850 }
<a name="l00851"></a>00851 
<a name="l00852"></a>00852 <span class="keywordtype">int</span>
<a name="l00853"></a>00853 resource_lipsum(<a class="code" href="structcoap__uri__t.html">coap_uri_t</a> *uri, coap_tid_t  *<span class="keywordtype">id</span>,
<a name="l00854"></a>00854         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mediatype, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset,
<a name="l00855"></a>00855         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *buflen,
<a name="l00856"></a>00856         <span class="keywordtype">int</span> *finished, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> method) {
<a name="l00857"></a>00857   <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> verylargebuf[] = <span class="stringliteral">&quot;Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris fermentum, lacus elementum venenatis aliquet, tortor risus laoreet sapien, a vulputate libero dolor ut odio. Vivamus congue elementum fringilla. Suspendisse porttitor, lectus sed gravida volutpat, dolor magna gravida massa, id fermentum lectus mi quis erat. Suspendisse lacinia, libero in euismod bibendum, magna nisi tempus lacus, eu suscipit augue nisi vel nulla. Praesent gravida lacus nec elit vestibulum sit amet rhoncus dui fringilla. Quisque diam lacus, ullamcorper non consectetur vitae, pellentesque eget lectus. Vestibulum velit nulla, venenatis vel mattis at, scelerisque nec mauris. Nulla facilisi. Mauris vel erat mi. Morbi et nulla nibh, vitae cursus eros. In convallis, magna egestas dictum porttitor, diam magna sagittis nisi, rhoncus tincidunt ligula felis sed mauris. Pellentesque pulvinar ante id velit convallis in porttitor justo imperdiet. Curabitur viverra placerat tincidunt. Vestibulum justo lacus, sollicitudin in facilisis vel, tempus nec erat. Duis varius viverra aliquet. In tempor varius elit vel pharetra. Sed mattis, quam in pulvinar ullamcorper, est ipsum tempor dui, at fringilla magna sem in sapien. Phasellus sollicitudin ornare sem, nec porta libero tempus vitae. Maecenas posuere pulvinar dictum. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Cras eros mauris, pulvinar tempor facilisis ut, condimentum in magna. Nullam eget ipsum sit amet lacus massa nunc.&lt;EOT&gt;&quot;</span>;
<a name="l00858"></a>00858   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxlen = <span class="keyword">sizeof</span>(verylargebuf) - 1;
<a name="l00859"></a>00859 
<a name="l00860"></a>00860   <span class="keywordflow">switch</span> (*mediatype) {
<a name="l00861"></a>00861   <span class="keywordflow">case</span> COAP_MEDIATYPE_ANY :
<a name="l00862"></a>00862   <span class="keywordflow">case</span> COAP_MEDIATYPE_TEXT_PLAIN :
<a name="l00863"></a>00863     *mediatype = COAP_MEDIATYPE_TEXT_PLAIN;
<a name="l00864"></a>00864     <span class="keywordflow">break</span>;
<a name="l00865"></a>00865   <span class="keywordflow">default</span> :
<a name="l00866"></a>00866     *buflen = 0;
<a name="l00867"></a>00867     *finished = 1;
<a name="l00868"></a>00868     <span class="keywordflow">return</span> COAP_RESPONSE_415;
<a name="l00869"></a>00869   }
<a name="l00870"></a>00870 
<a name="l00871"></a>00871   <span class="keywordflow">if</span> ( offset &gt; maxlen ) {
<a name="l00872"></a>00872     *buflen = 0;
<a name="l00873"></a>00873     <span class="keywordflow">return</span> COAP_RESPONSE_400;
<a name="l00874"></a>00874   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( offset + *buflen &gt; maxlen )
<a name="l00875"></a>00875     *buflen = maxlen - offset;
<a name="l00876"></a>00876 
<a name="l00877"></a>00877   memcpy(buf, verylargebuf + offset, *buflen);
<a name="l00878"></a>00878 
<a name="l00879"></a>00879   *finished = offset + *buflen == maxlen;
<a name="l00880"></a>00880   <span class="keywordflow">return</span> COAP_RESPONSE_200;
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883 <span class="keywordtype">int</span>
<a name="l00884"></a>00884 _resource_from_dir(<span class="keywordtype">char</span> *filename,
<a name="l00885"></a>00885            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mediatype, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset,
<a name="l00886"></a>00886            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *buflen,
<a name="l00887"></a>00887            <span class="keywordtype">int</span> *finished) {
<a name="l00888"></a>00888   DIR *dir;
<a name="l00889"></a>00889   <span class="keyword">struct </span>dirent *dirent;
<a name="l00890"></a>00890   <span class="keywordtype">size_t</span> namelen, overhead;
<a name="l00891"></a>00891   <span class="keywordtype">int</span> pos = 0;
<a name="l00892"></a>00892 
<a name="l00893"></a>00893   *finished = 1;
<a name="l00894"></a>00894 
<a name="l00895"></a>00895   <span class="keywordflow">switch</span> (*mediatype) {
<a name="l00896"></a>00896   <span class="keywordflow">case</span> COAP_MEDIATYPE_ANY :
<a name="l00897"></a>00897   <span class="keywordflow">case</span> COAP_MEDIATYPE_APPLICATION_LINK_FORMAT:
<a name="l00898"></a>00898     *mediatype = COAP_MEDIATYPE_APPLICATION_LINK_FORMAT;
<a name="l00899"></a>00899     <span class="keywordflow">break</span>;
<a name="l00900"></a>00900   <span class="comment">/* case COAP_MEDIATYPE_TEXT_PLAIN: */</span>
<a name="l00901"></a>00901   <span class="comment">/*   break; */</span>
<a name="l00902"></a>00902   <span class="keywordflow">default</span>:
<a name="l00903"></a>00903     *buflen = 0;
<a name="l00904"></a>00904     <span class="keywordflow">return</span> COAP_RESPONSE_415;
<a name="l00905"></a>00905   }
<a name="l00906"></a>00906 
<a name="l00907"></a>00907   <span class="keywordflow">if</span> ( (dir = opendir(filename)) == NULL ) {
<a name="l00908"></a>00908     perror(<span class="stringliteral">&quot;_resource_from_dir: opendir&quot;</span>);
<a name="l00909"></a>00909     *buflen = 0;
<a name="l00910"></a>00910     <span class="keywordflow">return</span> COAP_RESPONSE_404;
<a name="l00911"></a>00911   }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913   overhead = strlen(filename) + 10;
<a name="l00914"></a>00914 
<a name="l00915"></a>00915   errno = 0;
<a name="l00916"></a>00916   <span class="keywordflow">while</span> ( (dirent = readdir(dir)) ) {
<a name="l00917"></a>00917     namelen = strlen(dirent-&gt;d_name);
<a name="l00918"></a>00918 
<a name="l00919"></a>00919     <span class="comment">/* skip &#39;.&#39; and &#39;..&#39; as they are not allowed in CoAP URIs */</span>
<a name="l00920"></a>00920     <span class="keywordflow">if</span> ( dirent-&gt;d_name[0] == <span class="charliteral">&#39;.&#39;</span> ) {
<a name="l00921"></a>00921       <span class="keywordflow">if</span> ( namelen == 1 || (namelen == 2 &amp;&amp; dirent-&gt;d_name[1] == <span class="charliteral">&#39;.&#39;</span>) )
<a name="l00922"></a>00922     <span class="keywordflow">continue</span>;
<a name="l00923"></a>00923     }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <span class="keywordflow">if</span> (pos + overhead + namelen * 2 &gt; <span class="keyword">sizeof</span>(resource_buf) - 1)
<a name="l00926"></a>00926       <span class="keywordflow">break</span>;            <span class="comment">/* broken */</span>
<a name="l00927"></a>00927 
<a name="l00928"></a>00928     <span class="keywordflow">if</span> ( pos + overhead + namelen * 2 &lt; offset) {
<a name="l00929"></a>00929       offset -= overhead + namelen * 2;
<a name="l00930"></a>00930     } <span class="keywordflow">else</span> {
<a name="l00931"></a>00931       pos += sprintf(resource_buf + pos, <span class="stringliteral">&quot;&lt;/%s/%s&gt;;n=\&quot;%s\&quot;,&quot;</span>,
<a name="l00932"></a>00932              filename, dirent-&gt;d_name, dirent-&gt;d_name);
<a name="l00933"></a>00933     }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935     <span class="keywordflow">if</span> ( pos &gt; offset + *buflen )
<a name="l00936"></a>00936       <span class="keywordflow">break</span>;
<a name="l00937"></a>00937   }
<a name="l00938"></a>00938 
<a name="l00939"></a>00939   <span class="keywordflow">if</span> (errno != 0)
<a name="l00940"></a>00940     <span class="keywordflow">goto</span> error;
<a name="l00941"></a>00941 
<a name="l00942"></a>00942   closedir(dir);
<a name="l00943"></a>00943 
<a name="l00944"></a>00944   <span class="keywordflow">if</span> ( pos &lt;= offset ) {
<a name="l00945"></a>00945     *buflen = 0;
<a name="l00946"></a>00946     <span class="keywordflow">return</span> COAP_RESPONSE_400;
<a name="l00947"></a>00947   }
<a name="l00948"></a>00948 
<a name="l00949"></a>00949   <span class="keywordflow">if</span> ( (offset &lt; pos) &amp;&amp; (pos &lt;= offset + *buflen) ) {
<a name="l00950"></a>00950     *buflen = pos - offset - 1;
<a name="l00951"></a>00951     *finished = 1;
<a name="l00952"></a>00952   } <span class="keywordflow">else</span>
<a name="l00953"></a>00953     *finished = 0;
<a name="l00954"></a>00954 
<a name="l00955"></a>00955   memcpy(buf, resource_buf + offset, *buflen);
<a name="l00956"></a>00956 
<a name="l00957"></a>00957   <span class="keywordflow">return</span> COAP_RESPONSE_200;
<a name="l00958"></a>00958 
<a name="l00959"></a>00959  error:
<a name="l00960"></a>00960   perror(<span class="stringliteral">&quot;_resource_from_dir: readdir&quot;</span>);
<a name="l00961"></a>00961   closedir(dir);
<a name="l00962"></a>00962 
<a name="l00963"></a>00963   <span class="keywordflow">return</span> COAP_RESPONSE_500;
<a name="l00964"></a>00964 }
<a name="l00965"></a>00965 
<a name="l00966"></a>00966 <span class="keywordtype">int</span>
<a name="l00967"></a>00967 resource_from_file(<a class="code" href="structcoap__uri__t.html">coap_uri_t</a> *uri, coap_tid_t  *<span class="keywordtype">id</span>,
<a name="l00968"></a>00968            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mediatype, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset,
<a name="l00969"></a>00969            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *buflen,
<a name="l00970"></a>00970            <span class="keywordtype">int</span> *finished, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> method) {
<a name="l00971"></a>00971   <span class="keyword">static</span> <span class="keywordtype">char</span> filename[FILENAME_MAX+1];
<a name="l00972"></a>00972   <span class="keyword">struct </span>stat statbuf;
<a name="l00973"></a>00973   FILE *file;
<a name="l00974"></a>00974   <span class="keywordtype">int</span> code = COAP_RESPONSE_500; <span class="comment">/* result code */</span>
<a name="l00975"></a>00975 
<a name="l00976"></a>00976   <span class="keywordflow">if</span> (uri) {
<a name="l00977"></a>00977     memcpy(filename, uri-&gt;path.s, uri-&gt;path.length);
<a name="l00978"></a>00978     filename[uri-&gt;path.length] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00979"></a>00979 
<a name="l00980"></a>00980     <span class="keywordflow">if</span> (!is_valid(<span class="stringliteral">&quot;&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)filename, uri-&gt;path.length) ) {
<a name="l00981"></a>00981       fprintf(stderr, <span class="stringliteral">&quot;dropped invalid URI &#39;%s&#39;\n&quot;</span>, filename);
<a name="l00982"></a>00982       code = COAP_RESPONSE_404;
<a name="l00983"></a>00983       <span class="keywordflow">goto</span> error;
<a name="l00984"></a>00984     }
<a name="l00985"></a>00985   } <span class="keywordflow">else</span> {
<a name="l00986"></a>00986     fprintf(stderr, <span class="stringliteral">&quot;dropped NULL URI\n&quot;</span>);
<a name="l00987"></a>00987     code = COAP_RESPONSE_404;
<a name="l00988"></a>00988     <span class="keywordflow">goto</span> error;
<a name="l00989"></a>00989   }
<a name="l00990"></a>00990 
<a name="l00991"></a>00991   <span class="keywordflow">if</span> (stat(filename, &amp;statbuf) &lt; 0) {
<a name="l00992"></a>00992     perror(<span class="stringliteral">&quot;resource_from_file: stat&quot;</span>);
<a name="l00993"></a>00993     code = COAP_RESPONSE_404;
<a name="l00994"></a>00994     <span class="keywordflow">goto</span> error;
<a name="l00995"></a>00995   }
<a name="l00996"></a>00996 
<a name="l00997"></a>00997   <span class="keywordflow">if</span> ( S_ISDIR(statbuf.st_mode) ) {
<a name="l00998"></a>00998     <span class="comment">/* handle directory if mediatype allows */</span>
<a name="l00999"></a>00999     <span class="keywordflow">return</span> _resource_from_dir(filename, mediatype, offset, buf, buflen, finished);
<a name="l01000"></a>01000   }
<a name="l01001"></a>01001 
<a name="l01002"></a>01002   <span class="keywordflow">if</span> ( !S_ISREG(statbuf.st_mode) ) {
<a name="l01003"></a>01003     fprintf(stderr,<span class="stringliteral">&quot;%s not a regular file, skipped\n&quot;</span>, filename);
<a name="l01004"></a>01004     code = COAP_RESPONSE_404;
<a name="l01005"></a>01005     <span class="keywordflow">goto</span> error;
<a name="l01006"></a>01006   }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008   <span class="keywordflow">if</span> ( offset &gt; statbuf.st_size ) {
<a name="l01009"></a>01009     code = COAP_RESPONSE_400;
<a name="l01010"></a>01010     <span class="keywordflow">goto</span> error;
<a name="l01011"></a>01011   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( offset + *buflen &gt; statbuf.st_size )
<a name="l01012"></a>01012     *buflen = statbuf.st_size - offset;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014   file = fopen(filename, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l01015"></a>01015   <span class="keywordflow">if</span> ( !file ) {
<a name="l01016"></a>01016     perror(<span class="stringliteral">&quot;resource_from_file: fopen&quot;</span>);
<a name="l01017"></a>01017     code = COAP_RESPONSE_500;
<a name="l01018"></a>01018     <span class="keywordflow">goto</span> error;
<a name="l01019"></a>01019   }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021   <span class="keywordflow">if</span> ( fseek(file, offset, SEEK_SET) &lt; 0 ) {
<a name="l01022"></a>01022     perror(<span class="stringliteral">&quot;resource_from_file: fseek&quot;</span>);
<a name="l01023"></a>01023     code = COAP_RESPONSE_500;
<a name="l01024"></a>01024     <span class="keywordflow">goto</span> error;
<a name="l01025"></a>01025   }
<a name="l01026"></a>01026 
<a name="l01027"></a>01027   *buflen = fread(buf, 1, *buflen, file);
<a name="l01028"></a>01028   fclose(file);
<a name="l01029"></a>01029 
<a name="l01030"></a>01030   *finished = offset + *buflen &gt;= statbuf.st_size;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032   <span class="keywordflow">return</span> COAP_RESPONSE_200;
<a name="l01033"></a>01033 
<a name="l01034"></a>01034  error:
<a name="l01035"></a>01035   *buflen = 0;
<a name="l01036"></a>01036   *finished = 1;
<a name="l01037"></a>01037   <span class="keywordflow">return</span> code;
<a name="l01038"></a>01038 }
<a name="l01039"></a>01039 
<a name="l01040"></a>01040 <span class="keywordtype">int</span>
<a name="l01041"></a>01041 resource_ni(<a class="code" href="structcoap__uri__t.html">coap_uri_t</a> *uri, coap_tid_t  *<span class="keywordtype">id</span>,
<a name="l01042"></a>01042         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mediatype, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset,
<a name="l01043"></a>01043         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *buflen,
<a name="l01044"></a>01044         <span class="keywordtype">int</span> *finished, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> method) {
<a name="l01045"></a>01045   *finished = 1;
<a name="l01046"></a>01046   <span class="keywordflow">return</span> COAP_RESPONSE_200;
<a name="l01047"></a>01047 }
<a name="l01048"></a>01048 <span class="preprocessor">#define RESOURCE_SET_URI(r,st) \</span>
<a name="l01049"></a>01049 <span class="preprocessor">  (r)-&gt;uri = coap_new_uri((const unsigned char *)(st), strlen(st));</span>
<a name="l01050"></a>01050 <span class="preprocessor"></span>
<a name="l01051"></a>01051 <span class="preprocessor">#define RESOURCE_SET_DESC(r,st) \</span>
<a name="l01052"></a>01052 <span class="preprocessor">  (r)-&gt;name = coap_new_string(strlen(st));   \</span>
<a name="l01053"></a>01053 <span class="preprocessor">  if ((r)-&gt;name) {               \</span>
<a name="l01054"></a>01054 <span class="preprocessor">    (r)-&gt;name-&gt;length = strlen(st);              \</span>
<a name="l01055"></a>01055 <span class="preprocessor">    memcpy((r)-&gt;name-&gt;s, (st), (r)-&gt;name-&gt;length); \</span>
<a name="l01056"></a>01056 <span class="preprocessor">  }</span>
<a name="l01057"></a>01057 <span class="preprocessor"></span>
<a name="l01058"></a>01058 <span class="keywordtype">void</span>
<a name="l01059"></a>01059 init_resources(<a class="code" href="structcoap__context__t.html">coap_context_t</a> *ctx) {
<a name="l01060"></a>01060   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *u_lipsum = <span class="stringliteral">&quot;/lipsum&quot;</span>;
<a name="l01061"></a>01061   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *d_lipsum = <span class="stringliteral">&quot;some large text to test buffer sizes (&lt;EOT&gt; marks its end)&quot;</span>;
<a name="l01062"></a>01062   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *u_time = <span class="stringliteral">&quot;/time&quot;</span>;
<a name="l01063"></a>01063   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *d_time = <span class="stringliteral">&quot;server&#39;s local time and date&quot;</span>;
<a name="l01064"></a>01064   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *u_file = <span class="stringliteral">&quot;/filestorage&quot;</span>;
<a name="l01065"></a>01065   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *d_file = <span class="stringliteral">&quot;a single file, you can PUT things here&quot;</span>;
<a name="l01066"></a>01066   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *u_data = <span class="stringliteral">&quot;/data-sink&quot;</span>;
<a name="l01067"></a>01067   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *d_data = <span class="stringliteral">&quot;POSTed data is stored here&quot;</span>;
<a name="l01068"></a>01068   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *u_ni = <span class="stringliteral">&quot;/ni&quot;</span>;
<a name="l01069"></a>01069   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *d_ni = <span class="stringliteral">&quot;node integrate&quot;</span>;
<a name="l01070"></a>01070   <a class="code" href="structcoap__resource__t.html">coap_resource_t</a> *r;
<a name="l01071"></a>01071 
<a name="l01072"></a>01072   <span class="keywordflow">if</span> ( !(r = coap_malloc( <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>) )))
<a name="l01073"></a>01073     <span class="keywordflow">return</span>;
<a name="l01074"></a>01074 
<a name="l01075"></a>01075   memset(r, 0, <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>));
<a name="l01076"></a>01076   r-&gt;uri = coap_new_uri((<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<span class="stringliteral">&quot;/&quot;</span> COAP_DEFAULT_URI_WELLKNOWN,
<a name="l01077"></a>01077             <span class="keyword">sizeof</span>(COAP_DEFAULT_URI_WELLKNOWN));
<a name="l01078"></a>01078   r-&gt;mediatype = COAP_MEDIATYPE_APPLICATION_LINK_FORMAT;
<a name="l01079"></a>01079   r-&gt;dirty = 0;
<a name="l01080"></a>01080   r-&gt;writable = 0;
<a name="l01081"></a>01081   coap_add_resource( ctx, r );
<a name="l01082"></a>01082 
<a name="l01083"></a>01083   <span class="keywordflow">if</span> ( !(r = coap_malloc( <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>) )))
<a name="l01084"></a>01084     <span class="keywordflow">return</span>;
<a name="l01085"></a>01085 
<a name="l01086"></a>01086   memset(r, 0, <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>));
<a name="l01087"></a>01087   RESOURCE_SET_URI(r,u_lipsum);
<a name="l01088"></a>01088   RESOURCE_SET_DESC(r,d_lipsum);
<a name="l01089"></a>01089   r-&gt;mediatype = COAP_MEDIATYPE_TEXT_PLAIN;
<a name="l01090"></a>01090   r-&gt;dirty = 1;
<a name="l01091"></a>01091   r-&gt;writable = 0;
<a name="l01092"></a>01092   r-&gt;<a class="code" href="structcoap__resource__t.html#a621e59a8105e7d7a977714281a6e6967">data</a> = resource_lipsum;
<a name="l01093"></a>01093   r-&gt;maxage = 1209600;      <span class="comment">/* two weeks */</span>
<a name="l01094"></a>01094   coap_add_resource( ctx, r );
<a name="l01095"></a>01095 
<a name="l01096"></a>01096   <span class="keywordflow">if</span> ( !(r = coap_malloc( <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>) )))
<a name="l01097"></a>01097     <span class="keywordflow">return</span>;
<a name="l01098"></a>01098 
<a name="l01099"></a>01099   memset(r, 0, <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>));
<a name="l01100"></a>01100   RESOURCE_SET_URI(r,u_time);
<a name="l01101"></a>01101   RESOURCE_SET_DESC(r,d_time);
<a name="l01102"></a>01102   r-&gt;mediatype = COAP_MEDIATYPE_ANY;
<a name="l01103"></a>01103   r-&gt;dirty = 0;
<a name="l01104"></a>01104   r-&gt;writable = 0;
<a name="l01105"></a>01105   r-&gt;<a class="code" href="structcoap__resource__t.html#a621e59a8105e7d7a977714281a6e6967">data</a> = resource_time;
<a name="l01106"></a>01106   r-&gt;maxage = 1;
<a name="l01107"></a>01107   coap_add_resource( ctx, r );
<a name="l01108"></a>01108 
<a name="l01109"></a>01109   <span class="keywordflow">if</span> ( !(r = coap_malloc( <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>) )))
<a name="l01110"></a>01110     <span class="keywordflow">return</span>;
<a name="l01111"></a>01111 
<a name="l01112"></a>01112   memset(r, 0, <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>));
<a name="l01113"></a>01113   RESOURCE_SET_URI(r,u_file);
<a name="l01114"></a>01114   RESOURCE_SET_DESC(r,d_file);
<a name="l01115"></a>01115   r-&gt;mediatype = COAP_MEDIATYPE_ANY;
<a name="l01116"></a>01116   r-&gt;dirty = 0;
<a name="l01117"></a>01117   r-&gt;writable = 1;
<a name="l01118"></a>01118   r-&gt;<a class="code" href="structcoap__resource__t.html#a621e59a8105e7d7a977714281a6e6967">data</a> = resource_from_file;
<a name="l01119"></a>01119   write_file(<span class="stringliteral">&quot;filestorage&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<span class="stringliteral">&quot;initial text&quot;</span>, 12);
<a name="l01120"></a>01120   coap_add_resource( ctx, r );
<a name="l01121"></a>01121 
<a name="l01122"></a>01122   <span class="keywordflow">if</span> ( !(r = coap_malloc( <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>) )))
<a name="l01123"></a>01123     <span class="keywordflow">return</span>;
<a name="l01124"></a>01124 
<a name="l01125"></a>01125   memset(r, 0, <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>));
<a name="l01126"></a>01126   RESOURCE_SET_URI(r,u_data);
<a name="l01127"></a>01127   RESOURCE_SET_DESC(r,d_data);
<a name="l01128"></a>01128   r-&gt;mediatype = COAP_MEDIATYPE_APPLICATION_LINK_FORMAT;
<a name="l01129"></a>01129   r-&gt;dirty = 0;
<a name="l01130"></a>01130   r-&gt;writable = 0;
<a name="l01131"></a>01131   r-&gt;<a class="code" href="structcoap__resource__t.html#a621e59a8105e7d7a977714281a6e6967">data</a> = resource_from_file;
<a name="l01132"></a>01132   r-&gt;maxage = 10;
<a name="l01133"></a>01133   coap_add_resource(ctx, r);
<a name="l01134"></a>01134 
<a name="l01135"></a>01135   <span class="keywordflow">if</span> ( !(r = coap_malloc( <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>) )))
<a name="l01136"></a>01136     <span class="keywordflow">return</span>;
<a name="l01137"></a>01137 
<a name="l01138"></a>01138   memset(r, 0, <span class="keyword">sizeof</span>(<a class="code" href="structcoap__resource__t.html">coap_resource_t</a>));
<a name="l01139"></a>01139   RESOURCE_SET_URI(r,u_ni);
<a name="l01140"></a>01140   RESOURCE_SET_DESC(r,d_ni);
<a name="l01141"></a>01141   r-&gt;mediatype = COAP_MEDIATYPE_ANY;
<a name="l01142"></a>01142   r-&gt;dirty = 0;
<a name="l01143"></a>01143   r-&gt;writable = 1;
<a name="l01144"></a>01144   r-&gt;<a class="code" href="structcoap__resource__t.html#a621e59a8105e7d7a977714281a6e6967">data</a> = resource_ni;
<a name="l01145"></a>01145   r-&gt;maxage = 10;
<a name="l01146"></a>01146   coap_add_resource(ctx, r);
<a name="l01147"></a>01147 }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149 <span class="keywordtype">int</span>
<a name="l01150"></a>01150 main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {
<a name="l01151"></a>01151   <a class="code" href="structcoap__context__t.html">coap_context_t</a>  *ctx;
<a name="l01152"></a>01152   fd_set readfds;
<a name="l01153"></a>01153   <span class="keyword">struct </span>timeval tv, *timeout;
<a name="l01154"></a>01154   <span class="keywordtype">int</span> result;
<a name="l01155"></a>01155   time_t now;
<a name="l01156"></a>01156   <a class="code" href="structcoap__listnode.html">coap_queue_t</a> *nextpdu;
<a name="l01157"></a>01157   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> port = COAP_DEFAULT_PORT;
<a name="l01158"></a>01158   <span class="keywordtype">int</span> opt;
<a name="l01159"></a>01159   <span class="keywordtype">char</span> *group = NULL;
<a name="l01160"></a>01160 
<a name="l01161"></a>01161   <span class="keywordflow">while</span> ((opt = getopt(argc, argv, <span class="stringliteral">&quot;g:p:&quot;</span>)) != -1) {
<a name="l01162"></a>01162     <span class="keywordflow">switch</span> (opt) {
<a name="l01163"></a>01163     <span class="keywordflow">case</span> <span class="charliteral">&#39;g&#39;</span> :
<a name="l01164"></a>01164       group = optarg;
<a name="l01165"></a>01165       <span class="keywordflow">break</span>;
<a name="l01166"></a>01166     <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span> :
<a name="l01167"></a>01167       port = atoi(optarg);
<a name="l01168"></a>01168       <span class="keywordflow">break</span>;
<a name="l01169"></a>01169     <span class="keywordflow">default</span>:
<a name="l01170"></a>01170       usage( argv[0], PACKAGE_VERSION );
<a name="l01171"></a>01171       exit( 1 );
<a name="l01172"></a>01172     }
<a name="l01173"></a>01173   }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175   ctx = coap_new_context( port );
<a name="l01176"></a>01176   <span class="keywordflow">if</span> ( !ctx )
<a name="l01177"></a>01177     <span class="keywordflow">return</span> -1;
<a name="l01178"></a>01178 
<a name="l01179"></a>01179   <span class="keywordflow">if</span> ( group )
<a name="l01180"></a>01180     join( ctx, group );
<a name="l01181"></a>01181 
<a name="l01182"></a>01182   coap_register_message_handler( ctx, message_handler );
<a name="l01183"></a>01183   init_resources(ctx);
<a name="l01184"></a>01184 
<a name="l01185"></a>01185   signal(SIGINT, handle_sigint);
<a name="l01186"></a>01186 
<a name="l01187"></a>01187   <span class="keywordflow">while</span> ( !quit ) {
<a name="l01188"></a>01188     FD_ZERO(&amp;readfds);
<a name="l01189"></a>01189     FD_SET( ctx-&gt;sockfd, &amp;readfds );
<a name="l01190"></a>01190 
<a name="l01191"></a>01191     nextpdu = coap_peek_next( ctx );
<a name="l01192"></a>01192 
<a name="l01193"></a>01193     time(&amp;now);
<a name="l01194"></a>01194     <span class="keywordflow">while</span> ( nextpdu &amp;&amp; nextpdu-&gt;t &lt;= now ) {
<a name="l01195"></a>01195       coap_retransmit( ctx, coap_pop_next( ctx ) );
<a name="l01196"></a>01196       nextpdu = coap_peek_next( ctx );
<a name="l01197"></a>01197     }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     <span class="keywordflow">if</span> ( nextpdu &amp;&amp; nextpdu-&gt;t &lt;= now + COAP_RESOURCE_CHECK_TIME ) {
<a name="l01200"></a>01200       <span class="comment">/* set timeout if there is a pdu to send before our automatic timeout occurs */</span>
<a name="l01201"></a>01201       tv.tv_usec = 0;
<a name="l01202"></a>01202       tv.tv_sec = nextpdu-&gt;t - now;
<a name="l01203"></a>01203       timeout = &amp;tv;
<a name="l01204"></a>01204     } <span class="keywordflow">else</span> {
<a name="l01205"></a>01205       tv.tv_usec = 0;
<a name="l01206"></a>01206       tv.tv_sec = COAP_RESOURCE_CHECK_TIME;
<a name="l01207"></a>01207       timeout = &amp;tv;
<a name="l01208"></a>01208     }
<a name="l01209"></a>01209     result = select( FD_SETSIZE, &amp;readfds, 0, 0, timeout );
<a name="l01210"></a>01210 
<a name="l01211"></a>01211     <span class="keywordflow">if</span> ( result &lt; 0 ) {     <span class="comment">/* error */</span>
<a name="l01212"></a>01212       <span class="keywordflow">if</span> (errno != EINTR)
<a name="l01213"></a>01213     perror(<span class="stringliteral">&quot;select&quot;</span>);
<a name="l01214"></a>01214     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( result &gt; 0 ) {  <span class="comment">/* read from socket */</span>
<a name="l01215"></a>01215       <span class="keywordflow">if</span> ( FD_ISSET( ctx-&gt;sockfd, &amp;readfds ) ) {
<a name="l01216"></a>01216     coap_read( ctx );   <span class="comment">/* read received data */</span>
<a name="l01217"></a>01217     coap_dispatch( ctx );   <span class="comment">/* and dispatch PDUs from receivequeue */</span>
<a name="l01218"></a>01218       }
<a name="l01219"></a>01219     } <span class="keywordflow">else</span> {            <span class="comment">/* timeout */</span>
<a name="l01220"></a>01220       coap_check_resource_list( ctx );
<a name="l01221"></a>01221       coap_check_subscriptions( ctx );
<a name="l01222"></a>01222     }
<a name="l01223"></a>01223   }
<a name="l01224"></a>01224 
<a name="l01225"></a>01225   coap_free_context( ctx );
<a name="l01226"></a>01226 
<a name="l01227"></a>01227   <span class="keywordflow">return</span> 0;
<a name="l01228"></a>01228 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Fri Apr 25 2014 17:53:52 for libcoap by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
